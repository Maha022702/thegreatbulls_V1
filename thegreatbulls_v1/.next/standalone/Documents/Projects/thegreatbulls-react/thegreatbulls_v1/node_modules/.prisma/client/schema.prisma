generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// Enhanced User Model for Admin Panel
model User {
  id            String     @id @default(auto()) @map("_id") @db.ObjectId
  email         String     @unique
  name          String?
  password      String?
  image         String?
  phone         String?
  bio           String?
  role          UserRole   @default(USER)
  status        UserStatus @default(ACTIVE)
  emailVerified DateTime?
  phoneVerified Boolean    @default(false)
  lastLogin     DateTime?
  loginAttempts Int        @default(0)
  lockoutUntil  DateTime?

  // Profile Information
  firstName   String?
  lastName    String?
  dateOfBirth DateTime?
  gender      String?
  location    String?
  timezone    String?

  // Trading Profile
  tradingExperience String?
  riskTolerance     String?
  preferredMarkets  String[]

  // Admin fields
  createdBy String? @db.ObjectId
  updatedBy String? @db.ObjectId

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  enrollments     CourseEnrollment[]
  subscriptions   Subscription[]
  blogs           Blog[]
  reviews         Review[]
  payments        Payment[]
  notifications   Notification[]
  progress        UserProgress[]
  certificates    Certificate[]
  watchlist       WatchlistItem[]
  quizAttempts    QuizAttempt[]
  discussionPosts DiscussionPost[]
  discussions     Discussion[]
  adminActions    AdminAction[]
  createdCourses  Course[]           @relation("CourseCreator")
  managedCourses  Course[]           @relation("CourseManager")
}

// User Roles and Status
enum UserRole {
  SUPER_ADMIN
  ADMIN
  INSTRUCTOR
  MODERATOR
  USER
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  BANNED
  PENDING_VERIFICATION
}

// Enhanced Course Model
model Course {
  id               String   @id @default(auto()) @map("_id") @db.ObjectId
  title            String
  slug             String   @unique
  subtitle         String?
  description      String?
  shortDescription String?
  thumbnail        String?
  trailerVideo     String?
  previewImages    String[]

  // Pricing
  price              Float?
  originalPrice      Float?
  currency           String    @default("INR")
  discountPercent    Float?
  discountValidUntil DateTime?

  // Course Details
  level        CourseLevel
  language     String      @default("English")
  duration     Int // in minutes
  totalLessons Int         @default(0)
  totalModules Int         @default(0)
  totalQuizzes Int         @default(0)

  // Content
  overview         String?
  courseTopics     String[]
  skillsCovered    String[]
  prerequisites    String[]
  requirements     String[]
  whatYouWillLearn String[]
  learningOutcomes Json? // Enhanced structured learning outcomes
  targetAudience   String[]

  // Status and Visibility
  status      CourseStatus @default(DRAFT)
  isPublished Boolean      @default(false)
  publishedAt DateTime?
  expiryDate  DateTime? // Course access expiration date
  isFeatured  Boolean      @default(false)

  // Enrollment Limits
  maxEnrollments     Int? // Maximum number of students (null = unlimited)
  currentEnrollments Int  @default(0)

  // Categories and Tags
  categoryId String?     @db.ObjectId
  category   Category?   @relation(fields: [categoryId], references: [id])
  courseTags CourseTag[]

  // Instructor and Management
  instructorId String  @db.ObjectId
  instructor   User    @relation("CourseCreator", fields: [instructorId], references: [id])
  managerId    String? @db.ObjectId
  manager      User?   @relation("CourseManager", fields: [managerId], references: [id])

  // Certificate
  certificateTemplate String? // Template ID or name for course completion certificate

  // SEO and Marketing
  seoTitle       String?
  seoDescription String?
  keywords       String[]

  // Admin fields
  createdBy String? @db.ObjectId
  updatedBy String? @db.ObjectId

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  modules      CourseModule[]
  enrollments  CourseEnrollment[]
  reviews      Review[]
  discussions  Discussion[]
  certificates Certificate[]
}

// Course Enums
enum CourseLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

enum CourseStatus {
  DRAFT
  REVIEW
  PUBLISHED
  ARCHIVED
  DELETED
}

// Course Modules
model CourseModule {
  id       String @id @default(auto()) @map("_id") @db.ObjectId
  courseId String @db.ObjectId
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  title       String
  description String?
  order       Int
  duration    Int // in minutes
  isPublished Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  lessons Lesson[]
  quizzes Quiz[]
}

// Lessons
model Lesson {
  id       String       @id @default(auto()) @map("_id") @db.ObjectId
  moduleId String       @db.ObjectId
  module   CourseModule @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  title       String
  description String?
  content     String? // Rich text content
  order       Int
  duration    Int // in minutes
  isPublished Boolean @default(false)
  isPreview   Boolean @default(false)

  // Media Content
  videoUrl    String?
  videoType   String? // youtube, vimeo, upload
  videoId     String?
  attachments String[] // File URLs

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  progress UserProgress[]
}

// Quizzes
model Quiz {
  id       String       @id @default(auto()) @map("_id") @db.ObjectId
  moduleId String       @db.ObjectId
  module   CourseModule @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  title        String
  description  String?
  passingScore Int     @default(70) // percentage
  timeLimit    Int? // in minutes
  maxAttempts  Int     @default(3)
  isPublished  Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  questions QuizQuestion[]
  attempts  QuizAttempt[]
}

// Quiz Questions
model QuizQuestion {
  id     String @id @default(auto()) @map("_id") @db.ObjectId
  quizId String @db.ObjectId
  quiz   Quiz   @relation(fields: [quizId], references: [id], onDelete: Cascade)

  question      String
  type          QuestionType
  options       String[] // For multiple choice
  correctAnswer String
  explanation   String?
  order         Int
  points        Int          @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum QuestionType {
  MULTIPLE_CHOICE
  TRUE_FALSE
  SHORT_ANSWER
  ESSAY
}

// Categories and Tags
model Category {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  name        String  @unique
  slug        String  @unique
  description String?
  icon        String?
  color       String?
  order       Int     @default(0)
  isActive    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  courses Course[]
}

model Tag {
  id       String  @id @default(auto()) @map("_id") @db.ObjectId
  name     String  @unique
  slug     String  @unique
  color    String?
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  courseTags CourseTag[]
}

model CourseTag {
  id       String @id @default(auto()) @map("_id") @db.ObjectId
  courseId String @db.ObjectId
  tagId    String @db.ObjectId

  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  tag       Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([courseId, tagId])
}

// Enhanced Enrollment and Progress
model CourseEnrollment {
  id             String           @id @default(auto()) @map("_id") @db.ObjectId
  userId         String           @db.ObjectId
  courseId       String           @db.ObjectId
  enrollmentDate DateTime         @default(now())
  completionDate DateTime?
  progress       Float            @default(0) // percentage
  status         EnrollmentStatus @default(ACTIVE)
  certificateId  String?          @db.ObjectId

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, courseId])
}

enum EnrollmentStatus {
  ACTIVE
  COMPLETED
  DROPPED
  EXPIRED
}

model UserProgress {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  userId       String   @db.ObjectId
  lessonId     String   @db.ObjectId
  progress     Float    @default(0) // percentage
  completed    Boolean  @default(false)
  timeSpent    Int      @default(0) // in seconds
  lastAccessed DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson    Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, lessonId])
}

// Quiz Attempts
model QuizAttempt {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  userId      String    @db.ObjectId
  quizId      String    @db.ObjectId
  score       Float
  maxScore    Float
  percentage  Float
  passed      Boolean
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  timeSpent   Int // in seconds

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  quiz Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Reviews and Ratings
model Review {
  id         String  @id @default(auto()) @map("_id") @db.ObjectId
  userId     String  @db.ObjectId
  courseId   String  @db.ObjectId
  rating     Int // 1-5 stars
  title      String?
  comment    String
  isVerified Boolean @default(false)
  helpful    Int     @default(0)

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Certificates
model Certificate {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  userId        String    @db.ObjectId
  courseId      String    @db.ObjectId
  certificateId String    @unique
  issuedAt      DateTime  @default(now())
  validUntil    DateTime?
  downloadUrl   String?

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Payment and Subscription Management
model Subscription {
  id                String             @id @default(auto()) @map("_id") @db.ObjectId
  userId            String             @db.ObjectId
  planId            String             @db.ObjectId
  plan              SubscriptionPlan   @relation(fields: [planId], references: [id])
  status            SubscriptionStatus @default(ACTIVE)
  startDate         DateTime           @default(now())
  endDate           DateTime?
  autoRenew         Boolean            @default(true)
  cancelAtPeriodEnd Boolean            @default(false)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SubscriptionPlan {
  id            String          @id @default(auto()) @map("_id") @db.ObjectId
  name          String
  description   String?
  price         Float
  currency      String          @default("INR")
  interval      BillingInterval
  intervalCount Int             @default(1)
  features      String[]
  isActive      Boolean         @default(true)
  maxCourses    Int? // null = unlimited

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  subscriptions Subscription[]
}

enum BillingInterval {
  DAY
  WEEK
  MONTH
  YEAR
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  UNPAID
  INCOMPLETE
  INCOMPLETE_EXPIRED
  TRIALING
}

model Payment {
  id            String        @id @default(auto()) @map("_id") @db.ObjectId
  userId        String        @db.ObjectId
  amount        Float
  currency      String        @default("INR")
  status        PaymentStatus
  paymentMethod String?
  transactionId String?
  description   String?
  metadata      Json?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

// Content Management
model Blog {
  id        String     @id @default(auto()) @map("_id") @db.ObjectId
  title     String
  slug      String     @unique
  content   String
  excerpt   String?
  thumbnail String?
  status    BlogStatus @default(DRAFT)
  authorId  String     @db.ObjectId
  author    User       @relation(fields: [authorId], references: [id])
  tags      String[]
  category  String?

  // SEO
  seoTitle       String?
  seoDescription String?
  keywords       String[]

  // Analytics
  views Int @default(0)
  likes Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum BlogStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

// Discussions and Community
model Discussion {
  id       String  @id @default(auto()) @map("_id") @db.ObjectId
  courseId String  @db.ObjectId
  course   Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  title    String
  content  String
  authorId String  @db.ObjectId
  author   User    @relation(fields: [authorId], references: [id])
  isPinned Boolean @default(false)
  isLocked Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  posts DiscussionPost[]
}

model DiscussionPost {
  id           String           @id @default(auto()) @map("_id") @db.ObjectId
  discussionId String           @db.ObjectId
  discussion   Discussion       @relation(fields: [discussionId], references: [id], onDelete: Cascade)
  content      String
  authorId     String           @db.ObjectId
  author       User             @relation(fields: [authorId], references: [id])
  parentId     String?          @db.ObjectId // For nested replies
  parent       DiscussionPost?  @relation("DiscussionReplies", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  replies      DiscussionPost[] @relation("DiscussionReplies")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Watchlist
model WatchlistItem {
  id      String   @id @default(auto()) @map("_id") @db.ObjectId
  userId  String   @db.ObjectId
  symbol  String
  addedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, symbol])
}

// Notifications
model Notification {
  id      String           @id @default(auto()) @map("_id") @db.ObjectId
  userId  String           @db.ObjectId
  user    User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  title   String
  message String
  type    NotificationType
  isRead  Boolean          @default(false)
  data    Json? // Additional data for actions

  createdAt DateTime @default(now())
}

enum NotificationType {
  COURSE_UPDATE
  NEW_ENROLLMENT
  PAYMENT_SUCCESS
  PAYMENT_FAILED
  CERTIFICATE_ISSUED
  QUIZ_RESULT
  SYSTEM_ANNOUNCEMENT
  MARKETING
}

// Admin Actions Log
model AdminAction {
  id           String  @id @default(auto()) @map("_id") @db.ObjectId
  adminId      String  @db.ObjectId
  admin        User    @relation(fields: [adminId], references: [id])
  action       String // e.g., "CREATE_COURSE", "UPDATE_USER", "DELETE_CONTENT"
  resourceType String // e.g., "course", "user", "payment"
  resourceId   String?
  description  String
  metadata     Json? // Additional details about the action

  createdAt DateTime @default(now())
}

// Analytics and Reporting
model AnalyticsEvent {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  userId    String? @db.ObjectId
  eventType String // e.g., "page_view", "course_start", "lesson_complete"
  eventData Json
  sessionId String?
  userAgent String?
  ipAddress String?

  createdAt DateTime @default(now())
}
